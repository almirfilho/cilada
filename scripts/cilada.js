// Generated by CoffeeScript 1.3.3
(function() {
  var $canvas, Ball, Hole, Wall, b2Body, b2BodyDef, b2CircleShape, b2ContactListener, b2DebugDraw, b2Fixture, b2FixtureDef, b2PolygonShape, b2Vec2, b2World, ball, bodyDef, config, contact, ctx, endGame, fixDef, game, holes, init, update, walls, world;

  window.requestAnimFrame = (function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback, element) {
      return window.setTimeout(callback, 1000 / 60);
    };
  })();

  b2Vec2 = Box2D.Common.Math.b2Vec2;

  b2BodyDef = Box2D.Dynamics.b2BodyDef;

  b2Body = Box2D.Dynamics.b2Body;

  b2FixtureDef = Box2D.Dynamics.b2FixtureDef;

  b2Fixture = Box2D.Dynamics.b2Fixture;

  b2World = Box2D.Dynamics.b2World;

  b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;

  b2CircleShape = Box2D.Collision.Shapes.b2CircleShape;

  b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

  b2ContactListener = Box2D.Dynamics.b2ContactListener;

  config = {
    debug: false,
    width: 700,
    height: 432,
    scale: 30,
    ball: {
      iniX: 30,
      iniY: 35,
      radius: 15
    },
    walls: {
      qnt: 6,
      width: 15
    }
  };

  Ball = (function() {

    function Ball(x, y, radius) {
      this.x = x;
      this.y = y;
      this.radius = radius;
      this.position = new b2Vec2(this.x / config.scale, this.y / config.scale);
      this.impulse = new b2Vec2(0, 0);
      fixDef.density = 0.5;
      fixDef.friction = 1;
      fixDef.restitution = 0;
      fixDef.shape = new b2CircleShape(this.radius / config.scale);
      bodyDef.type = b2Body.b2_dynamicBody;
      bodyDef.position.x = this.position.x;
      bodyDef.position.y = this.position.y;
      bodyDef.linearDamping = 1;
      bodyDef.userData = this;
      this.b2Obj = world.CreateBody(bodyDef);
      this.b2Obj.CreateFixture(fixDef);
    }

    Ball.prototype.move = function() {
      this.b2Obj.ApplyImpulse(this.impulse, this.b2Obj.GetWorldCenter());
      return this.position = this.b2Obj.GetPosition();
    };

    Ball.prototype.draw = function() {
      if (game.alive) {
        this.x = this.position.x * config.scale;
        this.y = this.position.y * config.scale;
        ctx.save();
        ctx.fillStyle = ctx.createRadialGradient(this.x, this.y - 3, 2, this.x, this.y, this.radius);
        ctx.fillStyle.addColorStop(0, '#eee');
        ctx.fillStyle.addColorStop(1, '#444');
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
        ctx.closePath();
        ctx.shadowColor = 'rgba(0,0,0,0.7)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 6;
        ctx.fill();
        return ctx.restore();
      }
    };

    return Ball;

  })();

  Wall = (function() {

    function Wall(x, y, width, height) {
      this.x = x;
      this.y = y;
      this.width = width;
      this.height = height;
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.4;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(this.width / config.scale / 2, this.height / config.scale / 2);
      bodyDef.type = b2Body.b2_staticBody;
      bodyDef.position.x = (this.x / config.scale) + this.width / config.scale / 2;
      bodyDef.position.y = (this.y / config.scale) + this.height / config.scale / 2;
      this.b2Obj = world.CreateBody(bodyDef);
      this.b2Obj.CreateFixture(fixDef);
    }

    Wall.prototype.draw = function(shadow) {
      if (shadow == null) {
        shadow = null;
      }
      ctx.fillStyle = '#8C4600';
      ctx.save();
      if (shadow === 'block') {
        ctx.shadowColor = '#663300';
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
      } else if (shadow === 'shadow') {
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 12;
      }
      ctx.fillRect(this.x, this.y, this.width, this.height);
      return ctx.restore();
    };

    return Wall;

  })();

  Hole = (function() {

    function Hole(x, y, radius, winHole) {
      this.x = x;
      this.y = y;
      this.radius = radius;
      this.winHole = winHole != null ? winHole : false;
      fixDef.density = 1;
      fixDef.friction = 1;
      fixDef.restitution = 0;
      fixDef.shape = new b2CircleShape(this.radius / config.scale / 4);
      bodyDef.type = b2Body.b2_staticBody;
      bodyDef.position.x = this.x / config.scale;
      bodyDef.position.y = this.y / config.scale;
      bodyDef.linearDamping = 1;
      bodyDef.userData = this;
      this.b2Obj = world.CreateBody(bodyDef);
      this.b2Obj.CreateFixture(fixDef);
    }

    Hole.prototype.draw = function() {
      ctx.save();
      if (this.winHole) {
        ctx.fillStyle = ctx.createRadialGradient(this.x + 2, this.y + 5, 12, this.x + 2, this.y + 5, this.radius + 5);
        ctx.fillStyle.addColorStop(0, '#4C6600');
        ctx.fillStyle.addColorStop(1, 'black');
      } else {
        ctx.fillStyle = ctx.createRadialGradient(this.x + 2, this.y + 5, 12, this.x + 2, this.y + 5, this.radius + 5);
        ctx.fillStyle.addColorStop(0, '#713203');
        ctx.fillStyle.addColorStop(1, 'black');
      }
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
      ctx.closePath();
      ctx.fill();
      return ctx.restore();
    };

    return Hole;

  })();

  ball = null;

  walls = [];

  holes = [];

  game = {
    alive: true,
    win: false
  };

  $canvas = $('canvas');

  ctx = $canvas[0].getContext('2d');

  world = null;

  fixDef = null;

  bodyDef = null;

  contact = null;

  $canvas.attr({
    'width': config.width,
    'height': config.height
  });

  $canvas.css({
    'top': "-webkit-calc(50% - " + (config.height / 2) + "px)",
    'left': "-webkit-calc(50% - " + (config.width / 2) + "px)"
  });

  init = function() {
    var debugDraw, h, i, orientation, r, w, x, y, _i, _ref;
    world = new b2World(new b2Vec2(0, 0), true);
    fixDef = new b2FixtureDef;
    bodyDef = new b2BodyDef;
    game.alive = true;
    game.win = false;
    walls.push(new Wall(0, 0, config.width, config.walls.width));
    walls.push(new Wall(0, config.height - config.walls.width, config.width, config.walls.width));
    walls.push(new Wall(0, 0, config.walls.width, config.height));
    walls.push(new Wall(config.width - config.walls.width, 0, config.width, config.height));
    w = config.walls.width;
    h = config.height * 0.8;
    for (i = _i = 1, _ref = config.walls.qnt; 1 <= _ref ? _i <= _ref : _i >= _ref; i = 1 <= _ref ? ++_i : --_i) {
      x = i * ((config.width - config.walls.width) / (config.walls.qnt + 1));
      y = i % 2 === 0 ? config.height * 0.2 : 0;
      walls.push(new Wall(x, y, w, h));
    }
    r = config.ball.radius;
    holes.push(new Hole(80, 150, r));
    holes.push(new Hole(35, 300, r));
    holes.push(new Hole(170, 390, r));
    holes.push(new Hole(135, 240, r));
    holes.push(new Hole(175, 70, r));
    holes.push(new Hole(270, 150, r));
    holes.push(new Hole(301, 375, r));
    holes.push(new Hole(371, 250, r));
    holes.push(new Hole(330, 46, r));
    holes.push(new Hole(468, 110, r));
    holes.push(new Hole(440, 370, r));
    holes.push(new Hole(540, 320, r));
    holes.push(new Hole(620, 180, r));
    holes.push(new Hole(667, 130, r));
    holes.push(new Hole(643, 390, r, true));
    ball = new Ball(config.ball.iniX, config.ball.iniY, config.ball.radius);
    orientation = false;
    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', function(orientData) {
        ball.impulse.x = orientData.gamma / config.scale / 2;
        ball.impulse.y = orientData.beta / config.scale / 2;
        return orientation = true;
      });
    }
    if (window.DeviceMotionEvent && !orientation) {
      window.addEventListener('devicemotion', function(event) {
        ball.impulse.x = event.accelerationIncludingGravity.x / config.scale * (-3);
        ball.impulse.y = event.accelerationIncludingGravity.y / config.scale * 3;
        return orientation = true;
      });
    }
    contact = new b2ContactListener;
    contact.BeginContact = function(contact) {
      if (contact.GetFixtureA().GetBody().GetUserData() != null) {
        game.alive = false;
        if (contact.GetFixtureB().GetBody().GetUserData().winHole) {
          return game.win = true;
        }
      }
    };
    world.SetContactListener(contact);
    if (config.debug) {
      debugDraw = new b2DebugDraw();
      debugDraw.SetSprite(ctx);
      debugDraw.SetDrawScale(config.scale);
      debugDraw.SetFillAlpha(0.3);
      debugDraw.SetLineThickness(1.0);
      debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
      world.SetDebugDraw(debugDraw);
    }
    return requestAnimFrame(update);
  };

  update = function() {
    var hole, wall, _i, _j, _k, _l, _len, _len1, _len2, _len3;
    if (game.alive) {
      world.Step(1 / 60, 10, 10);
      ball.move();
      if (config.debug) {
        world.DrawDebugData();
      } else {
        ctx.clearRect(0, 0, config.width, config.height);
        for (_i = 0, _len = walls.length; _i < _len; _i++) {
          wall = walls[_i];
          wall.draw('shadow');
        }
        for (_j = 0, _len1 = holes.length; _j < _len1; _j++) {
          hole = holes[_j];
          hole.draw();
        }
        for (_k = 0, _len2 = walls.length; _k < _len2; _k++) {
          wall = walls[_k];
          wall.draw('block');
        }
        ball.draw();
        for (_l = 0, _len3 = walls.length; _l < _len3; _l++) {
          wall = walls[_l];
          wall.draw();
        }
      }
      world.ClearForces();
      return requestAnimFrame(update);
    } else {
      return endGame();
    }
  };

  endGame = function() {
    if (game.win) {
      return alert('ganhou');
    } else {
      return alert('perdeu playboy');
    }
  };

  init();

}).call(this);
